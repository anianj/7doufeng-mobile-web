define("saber-widget/ImageView",["require","saber-lang","saber-dom","hammer","./Widget","./main"],function(require){function t(){this.attrs={animate:{value:!0},speed:{value:200},zoomScale:{value:.88},switchAt:{value:.5},datasource:{value:[],repaint:!0},index:{value:0},toolbar:{value:!0,repaint:!0},flex:{value:!1,repaint:!0},full:{value:!1,setter:function(t){this.toggleState("full",t),r.toggleClass(this.main,"full",t)}},length:{readOnly:!0,getter:function(){return this.get("datasource").length}}},a.apply(this,arguments)}function e(t,e,i){var r=t.naturalWidth||t.width,o=t.naturalHeight||t.height,a=e.width,s=e.height;if(r>a)o*=a/r,r=a;if(o>s)r*=s/o,o=s;if(r*=i,o*=i,n(t,"width",r),n(t,"height",o),s>o)n(t,"margin-top",Math.round(Math.max((s-o)/2,0)))}function n(t,e,n){if(e=e||"width",arguments.length>2)return r.setStyle(t,e,(parseInt(n,10)||0)+"px");else return parseInt(r.getStyle(t,e),10)||0}var i=require("saber-lang"),r=require("saber-dom"),o=require("hammer"),a=require("./Widget");return t.prototype={type:"ImageView",initDom:function(){var t=this.runtime;if(t.viewport={width:window.innerWidth,height:window.innerHeight},this.main)t.setup=this.main,this.set("datasource",r.queryAll("[data-role=image]",this.main).map(function(t,e){return r.setData(t,"imageview",e),r.getData(t,"src")||t.getAttribute("src")}));var e=this.main=document.createElement("div");if(e.className="ui-imageview",r.hide(e),this.is("full"))r.addClass(e,"full");var n=t.toolbar=document.createElement("div");r.setData(n,"role","toolbar"),n.innerHTML=this.makeToolbar(),e.appendChild(n);var i=t.wrapper=document.createElement("div");r.setData(i,"role","wrapper"),e.appendChild(i),this.get("datasource").forEach(this._append,this),document.body.appendChild(e)},initEvent:function(){var t=this.runtime;t.scale=1;var e="release pinchin pinchout drag swipeleft swiperight tap doubletap";if(t.hammer=new o(t.wrapper,{dragLockToAxis:!0}).on(e,t.handler=i.bind(this._handleHammer,this)),this.on("beforedispose",function(){t.hammer.off(e,t.handler)}),t.setup)this.addEvent(t.setup,"click",function(t){if(r.matches(t.target,"[data-imageview]")){var e=r.getData(t.target,"imageview");if(e)this.enable().to(0|e)}});if(this.get("toolbar"))this.addEvent(t.toolbar,"touchstart",function(t){if(t.preventDefault(),r.matches(t.target,"[data-role=close]"))this.disable()}),this.on("change",function(){this.runtime.toolbar.innerHTML=this.makeToolbar()})},repaint:function(t){if(a.prototype.repaint.call(this,t),!t)return void this._resize(!0).to(this.get("index"),!0);if(t.hasOwnProperty("datasource")){var e=!this.is("disable");if(e)this.disable();if(this.runtime.wrapper.innerHTML="",t.datasource[1].forEach(this._append,this),e)this.enable().to(0)}if(t.hasOwnProperty("flex"))this[t.flex[1]?"enablePlugin":"disablePlugin"]("ImageViewFlex","flex")},enable:function(){if(this.is("render")){if(this.enablePlugin("Masker").enablePlugin("Zoom"),this.get("flex"))this.enablePlugin("ImageViewFlex","flex");r.show(this.main)}return a.prototype.enable.call(this),this},disable:function(){if(this.is("render")){if(this.disablePlugin("Masker").disablePlugin("Zoom"),this.get("flex"))this.disablePlugin("ImageViewFlex");r.hide(this.main)}return a.prototype.disable.call(this),this},_handleHammer:function(t){var e=t.gesture;e.preventDefault();var n=this.is("zoom"),i=this.runtime,r=i.viewport.width,o=this.get("index");switch(t.type){case"drag":var a=e.direction;if(n)this._drag(e.deltaX,e.deltaY);else if("left"===a||"right"===a){var s=this.get("length"),u=100/r*e.deltaX/s;if(0===o&&"right"===a||o===s-1&&"left"===a)u*=.4;this._move(this._percent(o)+u)}break;case"swipeleft":if(e.stopDetect(),!n)this.next();break;case"swiperight":if(e.stopDetect(),!n)this.prev();break;case"tap":this.set("full",!this.is("full"));break;case"doubletap":e.preventDefault(),this[n?"reset":"zoom"]();break;case"pinchin":this.zoom(i.scale-.2*e.scale),e.stopPropagation();break;case"pinchout":this.zoom(i.scale+.2*e.scale),e.stopPropagation();break;case"release":if(n)if(e.touches.length>1)e.stopDetect();else i.dragX+=e.deltaX,i.dragY+=e.deltaY;else if(Math.abs(e.deltaX)>r*this.get("switchAt"))this["right"===e.direction?"prev":"next"]();else this.to(o)}},_percent:function(t){var e=this.get("length");return t=Math.max(0,Math.min(e-1,t)),-(100/e)*t},_resize:function(t){var i=this.runtime,o=i.viewport,a={width:window.innerWidth,height:window.innerHeight};if(!t&&a.width===o.width&&a.height===o.height)return this;i.viewport=a;var s=this.get("zoomScale");return r.children(i.wrapper).forEach(function(t){n(t,"width",a.width);var i=r.query("img",t);if(i)e(i,a,s)}),n(i.wrapper,"width",a.width*this.get("length")),this.emit("resize",o,a),this},_append:function(){var t=document.createElement("div");r.setData(t,"role","item"),this.runtime.wrapper.appendChild(t)},_load:function(t){var n=r.queryAll("[data-role=item]",this.runtime.wrapper)[t];if(!n||!r.query("img",n)){var i=this;i.emit("beforeload",t);var o=document.createElement("img");r.hide(o),o.src=i.get("datasource")[t],o.onload=function(){this.onload=null,e(this,i.runtime.viewport,i.get("zoomScale")),r.show(this),i.emit("afterload",t)},n.appendChild(o)}},_move:function(t,e){var n=this.runtime.wrapper;if(this.get("animate"))r.setStyle(n,"transition","all "+(e||0)+"ms");return r.setStyle(n,"transform","translate3d("+t+"%, 0, 0) scale3d(1, 1, 1)"),this},_drag:function(t,e,n){var i=this.runtime,o=i.scale,a=this._image(this.get("index"));if(n=n||0,t=i.dragX+t,e=i.dragY+e,this.get("animate"))r.setStyle(a,"transition","all "+n+"ms");r.setStyle(a,"transform","translate3d("+t+"px, "+e+"px, 0) scale3d("+o+", "+o+", 1)")},_image:function(t){return r.query("[data-role=item]:nth-child("+(t+1)+") img",this.runtime.wrapper)},setup:function(t){if(t&&t!==this.runtime.setup)this.runtime.setup=t,this.set("datasource",r.queryAll("[data-role=image]",t).map(function(t,e){return r.setData(t,"imageview",e),r.getData(t,"src")||t.getAttribute("src")})),this._resize(!0)},makeToolbar:function(){return['<span data-role="close">关闭</span>',"<h1>"+(this.get("index")+1)+" of "+this.get("length")+"</h1>"].join("")},to:function(t,e){if(!e&&this.is("disable"))return this;if("number"!=typeof t){if(t=r.getData(t,"imageview"),!t)return this;t=0|t}if(this.is("zoom"))this.reset();var n=this.get("index");if(t=Math.max(0,Math.min(t,this.get("length")-1)),this._move(this._percent(t),this.get("speed")),n!==t)this.set("index",t),this.emit("change",n,t);return this._load(t),this},prev:function(){return this.to(this.get("index")-1)},next:function(){return this.to(this.get("index")+1)},zoom:function(t){if(!t&&this.is("zoom"))return this;if(t&&(.7>t||t>3))return this;this.addState("zoom");var e=this.runtime;e.scale=t||2,e.dragX=e.dragX||0,e.dragY=e.dragY||0,this._drag(0,0,this.get("speed")),this.emit("zoom",e.scale)},reset:function(){if(!this.is("zoom"))return this;this.removeState("zoom");var t=this.runtime;t.scale=1,t.dragX=0,t.dragY=0,this._drag(0,0,this.get("speed")),this.emit("reset")}},i.inherits(t,a),require("./main").register(t),t});