define("saber-firework/main",["require","saber-emitter","saber-promise","saber-tap","saber-lang/extend","saber-lang/bind","saber-lang/curry","saber-router","saber-viewport","./Action","./config"],function(require){function e(e){var t=w.processor||{};return t[e]}function t(e,t){if(clearTimeout(C.statusTimer),e===E&&!t)C.statusTimer=setTimeout(function(){C.status=x},w.timeout);C.status=e}function n(){t(x),a()}function r(){var e;Object.keys(A).forEach(function(t){if(e=A[t],C.action!==e)e.dispose()}),A={},y.delCache()}function i(e){var t=A[e];if(t){if(C.action!==t)t.dispose();delete A[e],y.delCache(e)}}function o(r){function s(e){if(t(E,!0),x("beforetransition"),!e){if(C.action=f,r.cached)A[r.path]=f}else C.action=null;if(C.route=r,C.page=w,C.path=r.path,e)return w.enter(h.type,h).then(m(p.rejected,p));else return w.enter(h.type,h)}function a(){return x("error"),s(!0)}function u(){k.forEach(function(e){f[e]()}),n()}var c=r.options||{};if("[object String]"===Object.prototype.toString.call(r.action))return void window.require([r.action],function(e){r.action=e,o(r)});if(r.path===C.path&&!c.force&&C.action&&C.action.refresh)return void C.action.refresh(r.query,r.options).then(n);if(c.noCache)i(r.path);if(C.action)C.action[A[C.path]?"sleep":"leave"]();var f=A[r.path];if(!f){var l;if(r.action&&r.action.constructor!==Object)l=r.action.constructor;else l=b;f=new l(r.action)}var h=r.transition||{},g=e("transition");if(g)d(h,g(r,C.route)||{});if(r.path===C.path)h.type=!1;var w=y.load(r.path,{cached:r.cached,noCache:c.noCache}),x=function(e,t){return function(n){exports.emit(n,e,t)}}({route:d({},r),action:f,page:w},{route:d({},C.route),action:C.action,page:C.page});w.on("afterenter",v(x,"afterload")),x("beforeload");var R,k=["complete"],O=[r.path,r.query,c];if(!A[r.path])R="enter",O.splice(2,0,w.main),k.unshift("ready");else R="wakeup";f[R].apply(f,O).then(s,a).then(u,n)}function s(e){function t(e){i+=e||R.length,n()}function n(){var o=R[i++];if(!o)r.resolve(e);else if(!o.url||o.url instanceof RegExp&&o.url.test(e.path)||o.url===e.path)o.filter(e,n,t);else n()}var r=new p,i=0;return n(),r.promise()}function a(){function e(e){if(n!==e.path)t(x),g.redirect(e.path,e.query,e.options);else o(e)}if(f&&C.status===x){t(E);var n=f.path;s(f).then(e),f=null}}function u(e,t,n,r,i){f=d({},e),f.path=t,f.query=n,f.options=i,f.url=r,a()}function c(e){var t=d(w,e);if(!Array.isArray(t.template))t.template=[t.template];return t}var f,l=require("saber-emitter"),p=require("saber-promise"),h=require("saber-tap"),d=require("saber-lang/extend"),m=require("saber-lang/bind"),v=require("saber-lang/curry"),g=require("saber-router"),y=require("saber-viewport"),b=require("./Action"),w=require("./config"),x=0,E=1,R=[],A={},C={};C.status=x;var exports={};return l.mixin(exports),exports.load=function(e){if(!Array.isArray(e))e=[e];e.forEach(function(e){g.add(e.path,v(u,e))})},exports.start=function(e,t){var n=c(t);y.init(e,n.viewport),h.mixin(document.body),g.config({index:n.index,path:n.path}),g.start()},exports.addFilter=function(e,t){if(1===arguments.length)t=e,e=null;R.push({url:e,filter:t})},exports.removeFilter=function(e){if(!e)R=[];else{var t,n=R.some(function(n,r){return t=r,n.url.toString()===e.toString()});if(n)R.splice(t,1)}},exports.delCachedAction=function(e){if(e)i(e);else r()},exports}),define("saber-firework",["saber-firework/main"],function(e){return e});